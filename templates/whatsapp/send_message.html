{% extends 'base.html' %}
{% load static %}

{% block title %}
  {{ page_title }} - Tsuru Groups
{% endblock %}

{% block extra_css %}
<style>
  .recipient-section {
    display: none;
  }
  .recipient-section.active {
    display: block;
  }
  .media-section {
    display: none;
  }
  .media-section.active {
    display: block;
  }
  .recipient-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.5rem;
  }
  .recipient-item {
    padding: 0.25rem;
    border-bottom: 1px solid #f8f9fa;
  }
  .recipient-item:last-child {
    border-bottom: none;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">
            <i class="fas fa-paper-plane me-2"></i>{{ page_title }}
          </h4>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data" id="sendMessageForm">
            {% csrf_token %}
            
            <!-- Instância WhatsApp -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="{{ form.whatsapp_instance.id_for_label }}" class="form-label">
                  {{ form.whatsapp_instance.label }}
                  <span class="text-danger">*</span>
                </label>
                {{ form.whatsapp_instance }}
                {% if form.whatsapp_instance.errors %}
                  <div class="text-danger small">{{ form.whatsapp_instance.errors }}</div>
                {% endif %}
              </div>
              
              <div class="col-md-6">
                <label for="{{ form.message_type.id_for_label }}" class="form-label">
                  {{ form.message_type.label }}
                  <span class="text-danger">*</span>
                </label>
                {{ form.message_type }}
                {% if form.message_type.errors %}
                  <div class="text-danger small">{{ form.message_type.errors }}</div>
                {% endif %}
              </div>
            </div>

            <!-- Tipo de Destinatário -->
            <div class="mb-3">
              <label for="{{ form.recipient_type.id_for_label }}" class="form-label">
                {{ form.recipient_type.label }}
                <span class="text-danger">*</span>
              </label>
              {{ form.recipient_type }}
              {% if form.recipient_type.errors %}
                <div class="text-danger small">{{ form.recipient_type.errors }}</div>
              {% endif %}
            </div>

            <!-- Seções de Destinatários -->
            <div id="groups-section" class="recipient-section mb-3">
              <label class="form-label">{{ form.groups.label }}</label>
              <div class="recipient-list">
                {{ form.groups }}
              </div>
              {% if form.groups.errors %}
                <div class="text-danger small">{{ form.groups.errors }}</div>
              {% endif %}
            </div>

            <div id="contacts-section" class="recipient-section mb-3">
              <label class="form-label">{{ form.contacts.label }}</label>
              <div class="recipient-list">
                {{ form.contacts }}
              </div>
              {% if form.contacts.errors %}
                <div class="text-danger small">{{ form.contacts.errors }}</div>
              {% endif %}
            </div>

            <div id="numbers-section" class="recipient-section mb-3">
              <label for="{{ form.phone_numbers.id_for_label }}" class="form-label">
                {{ form.phone_numbers.label }}
              </label>
              {{ form.phone_numbers }}
              <div class="form-text">
                Digite os números no formato internacional (ex: 5511999999999), um por linha.
              </div>
              {% if form.phone_numbers.errors %}
                <div class="text-danger small">{{ form.phone_numbers.errors }}</div>
              {% endif %}
            </div>

            <!-- Conteúdo da Mensagem -->
            <div class="mb-3">
              <label for="{{ form.message_content.id_for_label }}" class="form-label">
                {{ form.message_content.label }}
                <span class="text-danger">*</span>
              </label>
              {{ form.message_content }}
              <div class="form-text">
                <span id="char-count">0</span>/1000 caracteres
              </div>
              {% if form.message_content.errors %}
                <div class="text-danger small">{{ form.message_content.errors }}</div>
              {% endif %}
            </div>

            <!-- Seção de Mídia -->
            <div id="media-section" class="media-section mb-3">
              <label for="{{ form.media_file.id_for_label }}" class="form-label">
                {{ form.media_file.label }}
                <span class="text-danger">*</span>
              </label>
              {{ form.media_file }}
              <div class="form-text">
                Formatos suportados: JPG, PNG, GIF, MP4, MP3, PDF, DOC, DOCX (máx. 16MB)
              </div>
              {% if form.media_file.errors %}
                <div class="text-danger small">{{ form.media_file.errors }}</div>
              {% endif %}
            </div>

            <!-- Botões de Ação -->
            <div class="d-flex justify-content-between">
              <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Voltar
              </a>
              <button type="submit" class="btn btn-primary" id="sendButton">
                <i class="fas fa-paper-plane me-2"></i>Enviar Mensagem
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Preview da Mensagem -->
      <div class="card mt-4 shadow-sm">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-eye me-2"></i>Pré-visualização
          </h5>
        </div>
        <div class="card-body">
          <div class="whatsapp-preview bg-light p-3 rounded">
            <div class="message-bubble bg-success text-white p-2 rounded ms-auto" style="max-width: 70%; word-break: break-word;">
              <div id="preview-content">Digite sua mensagem para ver a pré-visualização...</div>
              <small class="d-block text-end opacity-75 mt-1">
                <i class="fas fa-clock me-1"></i>Agora
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar com Dicas -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-lightbulb me-2"></i>Dicas
          </h5>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <h6><i class="fas fa-info-circle me-2"></i>Envio de Mensagens</h6>
            <ul class="mb-0 small">
              <li>Certifique-se de que sua instância WhatsApp está conectada</li>
              <li>Mensagens são enviadas com intervalo de 3-6 segundos</li>
              <li>Para grupos, você precisa ser administrador</li>
              <li>Evite spam - respeite os limites do WhatsApp</li>
            </ul>
          </div>

          <div class="alert alert-warning">
            <h6><i class="fas fa-exclamation-triangle me-2"></i>Formatos de Mídia</h6>
            <ul class="mb-0 small">
              <li><strong>Imagens:</strong> JPG, PNG, GIF (máx. 5MB)</li>
              <li><strong>Vídeos:</strong> MP4, AVI (máx. 16MB)</li>
              <li><strong>Áudios:</strong> MP3, WAV, OGG (máx. 16MB)</li>
              <li><strong>Documentos:</strong> PDF, DOC, DOCX (máx. 100MB)</li>
            </ul>
          </div>

          <div class="alert alert-success">
            <h6><i class="fas fa-check-circle me-2"></i>Melhores Práticas</h6>
            <ul class="mb-0 small">
              <li>Personalize suas mensagens</li>
              <li>Use emojis com moderação</li>
              <li>Teste com poucos contatos primeiro</li>
              <li>Monitore as estatísticas de entrega</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const messageTypeField = document.getElementById('id_message_type');
  const recipientTypeField = document.getElementById('id_recipient_type');
  const messageContentField = document.getElementById('id_message_content');
  const instanceField = document.getElementById('id_whatsapp_instance');
  const mediaSection = document.getElementById('media-section');
  const charCount = document.getElementById('char-count');
  const previewContent = document.getElementById('preview-content');
  const sendButton = document.getElementById('sendButton');

  // Função para mostrar/ocultar seções de destinatários
  function toggleRecipientSections() {
    const recipientType = recipientTypeField.value;
    const sections = document.querySelectorAll('.recipient-section');
    
    sections.forEach(section => {
      section.classList.remove('active');
    });

    if (recipientType === 'groups') {
      document.getElementById('groups-section').classList.add('active');
    } else if (recipientType === 'contacts') {
      document.getElementById('contacts-section').classList.add('active');
    } else if (recipientType === 'numbers') {
      document.getElementById('numbers-section').classList.add('active');
    }
  }

  // Função para mostrar/ocultar seção de mídia
  function toggleMediaSection() {
    const messageType = messageTypeField.value;
    if (messageType === 'text') {
      mediaSection.classList.remove('active');
    } else {
      mediaSection.classList.add('active');
    }
  }

  // Função para atualizar contador de caracteres
  function updateCharCount() {
    const count = messageContentField.value.length;
    charCount.textContent = count;
    
    if (count > 1000) {
      charCount.classList.add('text-danger');
    } else {
      charCount.classList.remove('text-danger');
    }
  }

  // Função para atualizar pré-visualização
  function updatePreview() {
    const content = messageContentField.value;
    if (content.trim()) {
      previewContent.textContent = content;
    } else {
      previewContent.textContent = 'Digite sua mensagem para ver a pré-visualização...';
    }
  }

  // Função para carregar destinatários via AJAX
  function loadRecipients() {
    const instanceId = instanceField.value;
    const recipientType = recipientTypeField.value;
    
    if (!instanceId || recipientType === 'numbers') return;

    fetch(`{% url 'whatsapp:get_recipients_ajax' %}?instance_id=${instanceId}&type=${recipientType}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          console.error('Erro ao carregar destinatários:', data.error);
          return;
        }

        // Atualizar opções baseado no tipo
        if (recipientType === 'groups' && data.groups) {
          updateGroupOptions(data.groups);
        } else if (recipientType === 'contacts' && data.contacts) {
          updateContactOptions(data.contacts);
        }
      })
      .catch(error => {
        console.error('Erro na requisição AJAX:', error);
      });
  }

  // Função para atualizar opções de grupos
  function updateGroupOptions(groups) {
    const groupsContainer = document.querySelector('#groups-section .recipient-list');
    if (!groupsContainer) return;

    let html = '';
    groups.forEach(group => {
      html += `
        <div class="recipient-item">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="groups" value="${group.id}" id="group_${group.id}">
            <label class="form-check-label" for="group_${group.id}">
              <strong>${group.name}</strong>
              <small class="text-muted d-block">${group.participant_count} participantes</small>
            </label>
          </div>
        </div>
      `;
    });
    groupsContainer.innerHTML = html;
  }

  // Função para atualizar opções de contatos
  function updateContactOptions(contacts) {
    const contactsContainer = document.querySelector('#contacts-section .recipient-list');
    if (!contactsContainer) return;

    let html = '';
    contacts.forEach(contact => {
      html += `
        <div class="recipient-item">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="contacts" value="${contact.id}" id="contact_${contact.id}">
            <label class="form-check-label" for="contact_${contact.id}">
              <strong>${contact.name || contact.phone_number}</strong>
              <small class="text-muted d-block">${contact.phone_number}</small>
            </label>
          </div>
        </div>
      `;
    });
    contactsContainer.innerHTML = html;
  }

  // Event listeners
  messageTypeField.addEventListener('change', toggleMediaSection);
  recipientTypeField.addEventListener('change', function() {
    toggleRecipientSections();
    loadRecipients();
  });
  instanceField.addEventListener('change', loadRecipients);
  messageContentField.addEventListener('input', function() {
    updateCharCount();
    updatePreview();
  });

  // Inicializar
  toggleRecipientSections();
  toggleMediaSection();
  updateCharCount();
  updatePreview();

  // Validação do formulário
  document.getElementById('sendMessageForm').addEventListener('submit', function(e) {
    const instanceId = instanceField.value;
    const messageContent = messageContentField.value.trim();
    const recipientType = recipientTypeField.value;
    
    if (!instanceId) {
      e.preventDefault();
      alert('Selecione uma instância WhatsApp.');
      return;
    }
    
    if (!messageContent) {
      e.preventDefault();
      alert('Digite o conteúdo da mensagem.');
      return;
    }
    
    // Verificar se pelo menos um destinatário foi selecionado
    let hasRecipients = false;
    
    if (recipientType === 'groups') {
      hasRecipients = document.querySelectorAll('#groups-section input[type="checkbox"]:checked').length > 0;
    } else if (recipientType === 'contacts') {
      hasRecipients = document.querySelectorAll('#contacts-section input[type="checkbox"]:checked').length > 0;
    } else if (recipientType === 'numbers') {
      hasRecipients = document.getElementById('id_phone_numbers').value.trim().length > 0;
    }
    
    if (!hasRecipients) {
      e.preventDefault();
      alert('Selecione pelo menos um destinatário.');
      return;
    }

    // Desabilitar botão durante envio
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
  });
});
</script>
{% endblock %}
